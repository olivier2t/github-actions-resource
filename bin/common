#!/bin/bash

# -------------------------------------------------------------------------------------
# write the request payload to a tmp file
payload=$(mktemp /tmp/resource-in.XXXXXX)
cat > $payload <&0
echo $payload

# source config
source_base_url=$(jq -r '.source.base_url // "https://api.github.com"' < $payload)
source_owner=$(jq -r '.source.owner // ""' < $payload)
source_repo=$(jq -r '.source.repo // ""' < $payload)
source_workflow=$(jq -r '.source.workflow // ""' < $payload)
source_ref=$(jq -r '.source.ref // ""' < $payload)
source_token=$(jq -r '.source.token // ""' < $payload)
# correlation_id=$(jq -r --arg corr_prefix "$(openssl rand -hex 6)" '.source.correlation_prefix // $corr_prefix' < $payload)
# correlation_id+=$(date '+%Y%m%d%H%M%S')
source_variables=$(jq -r '.source.variables // ""' < $payload)

# check mandatory source config
if [ "${source_owner}" = "null" -o ${#source_owner} -le 3 ]; then
  jq  -n '[]' >&5
  exit 0
fi

# -------------------------------------------------------------------------------------
# helper functions
trim() {
  local var="$*"
  # remove leading whitespace characters
  var="${var#"${var%%[![:space:]]*}"}"
  # remove trailing whitespace characters
  var="${var%"${var##*[![:space:]]}"}"
  printf '%s' "$var"
}
